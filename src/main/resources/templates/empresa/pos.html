<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta | POS</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background-color: #f4f6f9; }
        .product-card { cursor: pointer; transition: transform 0.2s; border: none; shadow: sm; }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .product-img { height: 120px; object-fit: cover; border-radius: 5px 5px 0 0; }
        .pos-container { height: calc(100vh - 70px); }
        .scrollable-list { overflow-y: auto; max-height: 100%; }
        .cart-table-container { height: 400px; overflow-y: auto; }
        .stock-badge { position: absolute; top: 10px; right: 10px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-primary px-3 shadow-sm" style="height: 60px;">
        <span class="navbar-brand mb-0 h1"><i class="fas fa-cash-register me-2"></i>SISTEMA POS</span>
        <div class="text-white d-flex align-items-center">
            <span class="me-3"><i class="fas fa-building me-1"></i> <span th:text="${usuario.empresa.nombre}">Empresa</span></span>
            <span><i class="fas fa-user-circle me-1"></i> <span th:text="${usuario.nombres}">Vendedor</span></span>
            <a href="/logout" class="btn btn-sm btn-danger ms-3"><i class="fas fa-sign-out-alt"></i></a>
        </div>
    </nav>

    <div class="container-fluid py-3 pos-container">
        <div class="row h-100">
            
            <div class="col-md-7 col-lg-8 h-100 d-flex flex-column">
                
                <div class="card mb-3 shadow-sm border-0">
                    <div class="card-body p-2">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="inputBusqueda" class="form-control border-start-0" placeholder="Buscar producto por nombre, marca o código de barras..." onkeyup="filtrarProductos()">
                        </div>
                    </div>
                </div>

                <div class="flex-grow-1 scrollable-list pe-2">
                    <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3" id="contenedorProductos">
                        
                        <div class="col item-producto" th:each="prod : ${productos}" 
                             th:data-nombre="${prod.nombre.toLowerCase() + ' ' + (prod.codigoBarras != null ? prod.codigoBarras : '')}"
                             th:if="${prod.stock > 0}"> <div class="card product-card h-100 bg-white" 
                                 th:onclick="agregarAlCarrito([[${prod.idproducto}]], [[${prod.nombre}]], [[${prod.precio}]], [[${prod.stock}]])">
                                
                                <span class="badge bg-success stock-badge" th:text="'Stock: ' + ${prod.stock}">Stock</span>
                                
                                <img th:src="${prod.imagenUrl != null && !prod.imagenUrl.isEmpty() ? prod.imagenUrl : 'https://via.placeholder.com/150'}" 
                                     class="card-img-top product-img" alt="Producto">
                                
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title text-truncate mb-1" th:text="${prod.nombre}">Nombre</h6>
                                    <p class="card-text text-muted small mb-1" th:text="${prod.marca}"></p>
                                    <h5 class="text-primary fw-bold mb-0">S/ <span th:text="${#numbers.formatDecimal(prod.precio, 1, 2)}">0.00</span></h5>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 text-center mt-5" th:if="${productos.empty}">
                            <h4 class="text-muted">No hay productos disponibles en esta empresa.</h4>
                        </div>

                    </div>
                </div>
            </div>

            <div class="col-md-5 col-lg-4 h-100">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-header bg-white border-bottom-0 pt-3">
                        
                        <div class="mb-2">
                            <label class="small text-muted fw-bold">CLIENTE</label>
                            <div class="input-group">
                                <div class="mb-2">
                                <label class="small text-muted fw-bold">CLIENTE</label>
                                <div class="input-group mb-2">
                                    <select class="form-select" id="selectCliente" onchange="mostrarDetalleCliente()">
                                        <option value="" disabled selected>Seleccione Cliente...</option>
                                        
                                        <option th:each="cli : ${clientes}" 
                                                th:value="${cli.idusuario}" 
                                                th:text="${cli.numeroDocumento + ' - ' + (cli.razonSocial != null ? cli.razonSocial : cli.nombres)}"
                                                th:data-nombres="${cli.nombres}"
                                                th:data-razon="${cli.razonSocial}"
                                                th:data-direccion="${cli.direccionFiscal}"
                                                th:data-email="${cli.email}"
                                                th:data-telefono="${cli.telefono}"
                                                th:data-doc="${cli.numeroDocumento}">
                                        </option>
                                    </select>
                                    <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalNuevoCliente">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>

                                <div id="cardDetalleCliente" class="card border-info bg-light d-none mb-3">
                                    <div class="card-body p-2 small">
                                        <h6 class="text-primary fw-bold mb-1" id="lblClienteNombre">Nombre del Cliente</h6>
                                        
                                        <div class="d-flex justify-content-between text-muted mb-1">
                                            <span><i class="fas fa-id-card me-1"></i> <span id="lblClienteDoc">00000000</span></span>
                                            <span><i class="fas fa-phone me-1"></i> <span id="lblClienteTel">-</span></span>
                                        </div>
                                        
                                        <div class="mb-1">
                                            <i class="fas fa-map-marker-alt me-1 text-danger"></i> 
                                            <span id="lblClienteDir" class="fw-bold text-dark">Dirección...</span>
                                        </div>
                                        
                                        <div>
                                            <i class="fas fa-envelope me-1 text-secondary"></i> 
                                            <span id="lblClienteEmail">email@ejemplo.com</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalNuevoCliente">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="row g-2">
                            <div class="col-6">
                                <label class="small text-muted fw-bold">COMPROBANTE</label>
                                <select class="form-select" id="selectComprobante">
                                    <option th:each="comp : ${comprobantes}" 
                                            th:value="${comp.idTipoComprobante}" 
                                            th:text="${comp.nombre}">
                                    </option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="small text-muted fw-bold">FECHA</label>
                                <input type="text" class="form-control bg-light" th:value="${#temporals.format(#temporals.createNow(), 'dd/MM/yyyy')}" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="card-body p-0 cart-table-container bg-light border-top border-bottom">
                        <table class="table table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Producto</th>
                                    <th width="15%" class="text-center">Cant.</th>
                                    <th width="20%" class="text-end">Subtotal</th>
                                    <th width="5%"></th>
                                </tr>
                            </thead>
                            <tbody id="tablaCarrito">
                                <tr id="fila-vacia">
                                    <td colspan="4" class="text-center text-muted py-5">
                                        <i class="fas fa-shopping-basket fa-2x mb-2"></i><br>
                                        Carrito vacío
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card-footer bg-white border-top-0 pb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted">Subtotal:</span>
                            <span class="fw-bold">S/ <span id="lblSubtotal">0.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">IGV (18%):</span>
                            <span class="fw-bold">S/ <span id="lblIgv">0.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="h5 mb-0">TOTAL A PAGAR:</span>
                            <span class="h3 text-primary fw-bold mb-0">S/ <span id="lblTotal">0.00</span></span>
                        </div>
                        
                        <button class="btn btn-success w-100 py-2 fw-bold shadow-sm" onclick="procesarVenta()">
                            <i class="fas fa-check-circle me-2"></i> CONFIRMAR VENTA
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalNuevoCliente" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Nuevo Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formClienteRapido">
                        <div class="mb-3">
                            <label class="form-label">Tipo Documento</label>
                            <select class="form-select" id="new_tipoDoc" required onchange="cambiarFormularioCliente()">
                                <option value="" selected disabled>Seleccione...</option>
                                <option th:each="td : ${tiposDoc}" 
                                        th:value="${td.idTipoDocumento}" 
                                        th:text="${td.nombre}" 
                                        th:data-cod="${td.nombre}">
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Número Documento</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="new_numDoc" required placeholder="Ingrese DNI o RUC">
                                <button class="btn btn-outline-secondary" type="button" onclick="consultarApiExterna()"><i class="fas fa-search"></i> RENIEC/SUNAT</button>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="group_nombres">
                            <label class="form-label">Nombres Completos</label>
                            <input type="text" class="form-control" id="new_nombres">
                        </div>
                        <div class="mb-3 d-none" id="group_razonSocial">
                            <label class="form-label">Razón Social</label>
                            <input type="text" class="form-control" id="new_razonSocial">
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Teléfono</label>
                                <input type="text" class="form-control" id="new_telefono">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="new_email">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="new_direccion">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarCliente()">Guardar Cliente</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- VARIABLES GLOBALES ---
    let carrito = [];
    const IGV_RATE = 0.18;

    // --- 1. GESTIÓN DEL CARRITO (LÓGICA CLIENTE) ---
    function agregarAlCarrito(id, nombre, precio, stockMax) {
        const index = carrito.findIndex(item => item.id === id);

        if (index !== -1) {
            // El producto ya está, aumentamos cantidad
            if (carrito[index].cantidad < stockMax) {
                carrito[index].cantidad++;
            } else {
                Swal.fire('Stock Insuficiente', 'No puedes agregar más unidades de las disponibles.', 'warning');
                return;
            }
        } else {
            // Nuevo producto
            carrito.push({
                id: id,
                nombre: nombre,
                precio: parseFloat(precio),
                cantidad: 1,
                stockMax: stockMax
            });
        }
        renderizarCarrito();
    }

    function quitarDelCarrito(index) {
        carrito.splice(index, 1);
        renderizarCarrito();
    }

    function cambiarCantidad(index, cambio) {
        const item = carrito[index];
        const nuevaCantidad = item.cantidad + cambio;

        if (nuevaCantidad > 0 && nuevaCantidad <= item.stockMax) {
            item.cantidad = nuevaCantidad;
        } else if (nuevaCantidad > item.stockMax) {
            Swal.fire('Stock límite', 'Solo quedan ' + item.stockMax + ' unidades.', 'warning');
        }
        renderizarCarrito();
    }

    function renderizarCarrito() {
        const tbody = document.getElementById('tablaCarrito');
        tbody.innerHTML = '';

        let subtotal = 0;

        if (carrito.length === 0) {
            tbody.innerHTML = `
                <tr id="fila-vacia">
                    <td colspan="4" class="text-center text-muted py-5">
                        <i class="fas fa-shopping-basket fa-2x mb-2"></i><br>Carrito vacío
                    </td>
                </tr>`;
        } else {
            carrito.forEach((item, index) => {
                const totalItem = item.precio * item.cantidad;
                subtotal += totalItem;

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div class="fw-bold small">${item.nombre}</div>
                            <div class="text-muted small">Unit: S/ ${item.precio.toFixed(2)}</div>
                        </td>
                        <td class="text-center align-middle">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary py-0" onclick="cambiarCantidad(${index}, -1)">-</button>
                                <button class="btn btn-outline-secondary py-0" disabled>${item.cantidad}</button>
                                <button class="btn btn-outline-secondary py-0" onclick="cambiarCantidad(${index}, 1)">+</button>
                            </div>
                        </td>
                        <td class="text-end align-middle fw-bold">
                            S/ ${totalItem.toFixed(2)}
                        </td>
                        <td class="align-middle">
                            <button class="btn btn-sm text-danger" onclick="quitarDelCarrito(${index})"><i class="fas fa-times"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        // Cálculos Totales
        const total = subtotal;
        const baseImponible = total / (1 + IGV_RATE);
        const igv = total - baseImponible;

        document.getElementById('lblSubtotal').textContent = baseImponible.toFixed(2);
        document.getElementById('lblIgv').textContent = igv.toFixed(2);
        document.getElementById('lblTotal').textContent = total.toFixed(2);
    }

    // --- 2. FILTRO DE PRODUCTOS ---
    function filtrarProductos() {
        const texto = document.getElementById('inputBusqueda').value.toLowerCase();
        const items = document.querySelectorAll('.item-producto');
        
        items.forEach(item => {
            const data = item.getAttribute('data-nombre');
            if (data.includes(texto)) {
                item.classList.remove('d-none');
            } else {
                item.classList.add('d-none');
            }
        });
    }

    // --- 3. LÓGICA MODAL CLIENTE Y VISUALIZACIÓN ---

    // A. Mostrar/Ocultar campos según DNI o RUC
    function cambiarFormularioCliente() {
        const select = document.getElementById('new_tipoDoc');
        const texto = select.options[select.selectedIndex].text.toUpperCase();
        
        const groupNombres = document.getElementById('group_nombres');
        const groupRazon = document.getElementById('group_razonSocial');

        if (texto.includes('RUC')) {
            groupNombres.classList.add('d-none');
            groupRazon.classList.remove('d-none');
        } else {
            groupNombres.classList.remove('d-none');
            groupRazon.classList.add('d-none');
        }
    }
    
    // B. Mostrar Tarjeta con Datos del Cliente Seleccionado
    function mostrarDetalleCliente() {
        const select = document.getElementById('selectCliente');
        const detalleCard = document.getElementById('cardDetalleCliente');
        
        // Obtener la opción seleccionada actualmente
        const option = select.options[select.selectedIndex];

        // Si no hay valor (es el placeholder), ocultar tarjeta
        if (!select.value) {
            detalleCard.classList.add('d-none');
            return;
        }

        // Extraer datos de los atributos data-*
        const numDoc = option.getAttribute('data-doc');
        const nombres = option.getAttribute('data-nombres'); // Persona natural
        const razonSocial = option.getAttribute('data-razon'); // Empresa
        const direccion = option.getAttribute('data-direccion');
        const email = option.getAttribute('data-email');
        const telefono = option.getAttribute('data-telefono');

        // Lógica de visualización (Nombre vs Razón Social)
        let nombreMostrar = nombres;
        
        // Si tiene Razón Social (es empresa/RUC), mostramos Razón Social
        if (razonSocial && razonSocial !== 'null' && razonSocial.trim() !== '') {
            nombreMostrar = razonSocial;
        }

        // Asignar valores a los elementos HTML
        document.getElementById('lblClienteNombre').textContent = nombreMostrar || 'Cliente sin nombre';
        document.getElementById('lblClienteDoc').textContent = numDoc || '-';
        
        // Validar nulos para mostrar guiones o texto vacío si no hay datos
        document.getElementById('lblClienteDir').textContent = (direccion && direccion !== 'null') ? direccion : 'Sin dirección';
        document.getElementById('lblClienteTel').textContent = (telefono && telefono !== 'null') ? telefono : 'Sin telf.';
        document.getElementById('lblClienteEmail').textContent = (email && email !== 'null') ? email : 'Sin email';

        // Mostrar la tarjeta
        detalleCard.classList.remove('d-none');
    }

    function consultarApiExterna() {
        // Placeholder para futura implementación de API RENIEC/SUNAT
        Swal.fire('Info', 'Aquí conectarías una API de consulta de DNI/RUC', 'info');
    }

    function guardarCliente() {
        const data = {
            idTipoDoc: document.getElementById('new_tipoDoc').value,
            numDoc: document.getElementById('new_numDoc').value,
            nombres: document.getElementById('new_nombres').value,
            razonSocial: document.getElementById('new_razonSocial').value,
            telefono: document.getElementById('new_telefono').value,
            email: document.getElementById('new_email').value,
            direccion: document.getElementById('new_direccion').value
        };

        if(!data.idTipoDoc || !data.numDoc) {
            Swal.fire('Error', 'Debe seleccionar tipo y número de documento', 'error');
            return;
        }

        fetch('/admin/pos/cliente/guardar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) return response.json().then(err => { throw err; });
            return response.json();
        })
        .then(cliente => {
            // Agregar al select
            const select = document.getElementById('selectCliente');
            const option = document.createElement('option');
            option.value = cliente.idusuario;
            option.text = cliente.numeroDocumento + ' - ' + (cliente.razonSocial || cliente.nombres);
            
            // --- IMPORTANTE: AGREGAR LOS ATRIBUTOS DATA AL NUEVO CLIENTE ---
            // Esto permite que la tarjeta de detalles funcione inmediatamente
            option.setAttribute('data-nombres', cliente.nombres || '');
            option.setAttribute('data-razon', cliente.razonSocial || '');
            option.setAttribute('data-doc', cliente.numeroDocumento || '');
            option.setAttribute('data-direccion', cliente.direccionFiscal || '');
            option.setAttribute('data-email', cliente.email || '');
            option.setAttribute('data-telefono', cliente.telefono || '');
            // ---------------------------------------------------------------

            option.selected = true;
            select.add(option);
            
            // Disparar manualmente la visualización de la tarjeta
            mostrarDetalleCliente();

            // Cerrar modal y limpiar
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevoCliente'));
            modal.hide();
            Swal.fire('Éxito', 'Cliente registrado correctamente', 'success');
            document.getElementById('formClienteRapido').reset();
            
        })
        .catch(err => {
            Swal.fire('Error', err.message || 'No se pudo guardar el cliente', 'error');
        });
    }

    // --- 4. PROCESAR VENTA ---
    function procesarVenta() {
        const idCliente = document.getElementById('selectCliente').value;
        const idComprobante = document.getElementById('selectComprobante').value;
        const totalVenta = parseFloat(document.getElementById('lblTotal').textContent);

        if (carrito.length === 0) {
            Swal.fire('Carrito vacío', 'Agregue productos antes de procesar.', 'warning');
            return;
        }
        if (!idCliente) {
            Swal.fire('Falta Cliente', 'Seleccione un cliente para la venta.', 'warning');
            return;
        }
        if (!idComprobante) {
            Swal.fire('Falta Comprobante', 'Seleccione el tipo de comprobante.', 'warning');
            return;
        }

        // Construir Payload
        const payload = {
            idCliente: idCliente,
            idTipoComprobante: idComprobante,
            total: totalVenta,
            items: carrito.map(item => ({
                id: item.id,
                cantidad: item.cantidad,
                precio: item.precio
            }))
        };

        Swal.fire({
            title: '¿Procesar Venta?',
            text: `Total a cobrar: S/ ${totalVenta.toFixed(2)}`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            confirmButtonText: 'Sí, cobrar'
        }).then((result) => {
            if (result.isConfirmed) {
                
                fetch('/admin/pos/procesar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(res => {
                    if (!res.ok) return res.text().then(text => { throw new Error(text) });
                    return res.json();
                })
                .then(data => {
                    Swal.fire({
                        title: '¡Venta Exitosa!',
                        text: 'ID Venta: ' + data.idVenta,
                        icon: 'success'
                    }).then(() => {
                        window.location.reload(); 
                    });
                })
                .catch(err => {
                    Swal.fire('Error', 'Hubo un problema al procesar: ' + err.message, 'error');
                });
            }
        });
    }
    </script>
</body>
</html>