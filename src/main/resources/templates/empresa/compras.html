<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Compras | TechAdmin</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/normalize.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <nav class="navbar">
        <div class="logo"><a th:href="@{/admin/dashboard}">Tech<span>Admin</span></a></div>
        
        <div class="nav-menu">
            <ul class="nav-links">
                <li><a th:href="@{/admin/dashboard}">Dashboard</a></li>
                <li><a th:href="@{/admin/pos}">Ventas / POS</a></li> 
                <li><a th:href="@{/admin/inventario}">Inventario</a></li>

                <li th:if="${session.usuario.tipoUsuario.nombreRol == 'ADMIN' or session.usuario.tipoUsuario.nombreRol == 'ADMIN_VENDEDOR'}">
                    <a th:href="@{/admin/compras}" class="active">Compras</a>
                </li>

                <li th:if="${session.usuario.tipoUsuario.nombreRol == 'ADMIN' or session.usuario.tipoUsuario.nombreRol == 'ADMIN_VENDEDOR'}">
                    <a th:href="@{/admin/proveedores}">Proveedores</a>
                </li>

                <li><a th:href="@{/admin/servicios}">Servicios</a></li>
                <li><a th:href="@{/admin/usuarios}">Clientes</a></li>
                <li><a th:href="@{/admin/reportes}">Reportes</a></li>
                <li><a th:href="@{/admin/mantenimiento}">Mantenimiento</a></li>
            </ul>

            <div class="auth-buttons">
                <div style="text-align: right; color: white; margin-right: 10px;">
                    <span style="font-weight: bold; display: block;" th:text="${session.usuario.nombres}">Usuario</span>
                    <small style="color: #cbd5e1;" th:text="${session.usuario.tipoUsuario.nombreRol}">Rol</small>
                </div>
                <a th:href="@{/logout}" class="btn btn-outline" style="border-color: #ef4444; color: #ef4444;">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
        <div class="burger" id="burgerBtn"><i class="fas fa-bars"></i></div>
    </nav>

    <div class="page-wrapper">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #ffffff;">Gestión de Compras</h2>
            <a th:href="@{/admin/dashboard}" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>

        <div class="content-box">
            
            <div th:if="${exito}" style="background:#dcfce7; color:#166534; padding:10px; margin-bottom:20px; border-radius:5px; border: 1px solid #bbf7d0;">
                <i class="fas fa-check-circle"></i> <span th:text="${exito}"></span>
            </div>
            <div th:if="${error}" style="background:#fee2e2; color:#991b1b; padding:10px; margin-bottom:20px; border-radius:5px; border: 1px solid #fecaca;">
                <i class="fas fa-exclamation-circle"></i> <span th:text="${error}"></span>
            </div>

            <div style="background: #f0fdf4; padding: 25px; border-radius: 8px; border: 1px solid #bbf7d0; margin-bottom: 40px;">
                <h4 style="margin-top: 0; color: #166534; margin-bottom: 15px;">Registrar Nueva Compra</h4>
                
                <form th:action="@{/admin/compras/guardar}" method="post" th:object="${nuevaCompra}">
                    
                    <div class="form-grid">
                        <div>
                            <label style="display:block; margin-bottom:5px; font-weight:bold;">Proveedor</label>
                            <select th:field="*{proveedor}" class="form-control" required style="width: 100%; padding: 8px;">
                                <option value="">-- Seleccione Proveedor --</option>
                                <option th:each="p : ${proveedores}" 
                                        th:value="${p.idproveedor}" 
                                        th:text="${p.razonSocial + ' (RUC: ' + p.ruc + ')'}"></option>
                            </select>
                        </div>

                        <div>
                            <label style="display:block; margin-bottom:5px; font-weight:bold;">N° Comprobante</label>
                            <input type="text" th:field="*{numeroComprobante}" class="form-control" placeholder="Ej: F001-00045" required style="width: 100%; padding: 8px;">
                        </div>

                        <div>
                            <label style="display:block; margin-bottom:5px; font-weight:bold;">Monto Total (S/)</label>
                            <input type="number" step="0.01" min="0" th:field="*{montoTotal}" class="form-control" placeholder="0.00" required style="width: 100%; padding: 8px;">
                        </div>
                    </div>

                    <hr style="border-top: 1px dashed #cbd5e1; margin: 20px 0;">

                    <h5 style="color: #475569; margin-bottom: 10px;">Detalle de Productos</h5>
                    
                    <div class="row mb-3 align-items-end" style="background: #fff; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <div style="flex: 2; min-width: 250px;">
                            <label style="display:block; font-weight:bold; margin-bottom:5px;">Buscar Producto</label>
                            <div style="display: flex; gap: 5px;">
                                <select id="selectProducto" class="form-control" style="flex: 1; padding: 8px;">
                                    <option value="">-- Seleccione producto existente --</option>
                                    <option th:each="p : ${productos}" 
                                            th:value="${p.idproducto}" 
                                            th:text="${p.nombre + ' - ' + p.marca}"></option>
                                </select>
                                <button type="button" class="btn btn-filled" style="background: #2563eb;" data-bs-toggle="modal" data-bs-target="#modalNuevoProducto">
                                    <i class="fas fa-plus"></i> Nuevo
                                </button>
                            </div>
                        </div>
                        
                        <div style="flex: 1; min-width: 100px;">
                            <label style="display:block; font-weight:bold; margin-bottom:5px;">Cantidad</label>
                            <input type="number" id="inputCantidad" class="form-control" value="1" min="1" style="width: 100%; padding: 8px;">
                        </div>
                        
                        <div style="flex: 1; min-width: 100px;">
                            <label style="display:block; font-weight:bold; margin-bottom:5px;">Costo Unit. (S/)</label>
                            <input type="number" id="inputCosto" class="form-control" placeholder="0.00" step="0.01" style="width: 100%; padding: 8px;">
                        </div>
                        
                        <div style="flex: 1; min-width: 100px; display: flex; align-items: flex-end;">
                            <button type="button" class="btn btn-filled" style="background: #16a34a; width: 100%;" onclick="agregarLineaCompra()">
                                <i class="fas fa-check"></i> Agregar
                            </button>
                        </div>
                    </div>

                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                <tr>
                                    <th style="padding: 10px; text-align: left;">Producto</th>
                                    <th style="padding: 10px; text-align: center;">Cant.</th>
                                    <th style="padding: 10px; text-align: right;">Costo</th>
                                    <th style="padding: 10px; text-align: right;">Subtotal</th>
                                    <th style="padding: 10px;"></th>
                                </tr>
                            </thead>
                            <tbody id="tablaDetallesCompra">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 15px; color: #94a3b8;">Agrega productos a la compra...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button type="button" class="btn btn-filled" onclick="guardarCompraBD()" style="background: #1e293b; color: white; padding: 12px 30px; font-size: 1rem;">
                            <i class="fas fa-save"></i> Guardar Compra Completa
                        </button>
                    </div>
                </form>
            </div>

            <hr style="margin: 30px 0; border:0; border-top:1px solid #e2e8f0;">

            <h3 style="margin-bottom: 15px; color: #475569;">Historial de Compras Recientes</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f8fafc; text-align: left;">
                            <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">ID</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">Fecha</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">Proveedor</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">Comprobante</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">Responsable</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">Monto</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="c : ${compras}" style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 12px;" th:text="${c.idcompra}">#1</td>
                            <td style="padding: 12px;" th:text="${#temporals.format(c.fechaCompra, 'dd/MM/yyyy HH:mm')}">Fecha</td>
                            
                            <td style="padding: 12px;" th:text="${c.proveedor != null ? c.proveedor.razonSocial : 'Proveedor Eliminado'}">Prov</td>
                            
                            <td style="padding: 12px;" th:text="${c.numeroComprobante}">001</td>
                            <td style="padding: 12px;" th:text="${c.usuario != null ? c.usuario.nombres : 'Desconocido'}">Resp</td>
                            <td style="padding: 12px; font-weight:bold; color: #166534;">S/ <span th:text="${#numbers.formatDecimal(c.montoTotal, 1, 2)}">0.00</span></td>
                            <td style="padding: 12px;">
                                <span style="background:#dbeafe; color:#1e40af; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold;" th:text="${c.estado}">COMPLETADO</span>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(compras)}">
                            <td colspan="7" style="text-align:center; padding:30px; color:#64748b;">
                                <i class="fas fa-box-open fa-2x" style="margin-bottom: 10px; display: block; opacity: 0.5;"></i>
                                No se encontraron compras registradas.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalNuevoProducto" tabindex="-1" aria-hidden="true" style="color: #333;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white" style="background: #2563eb;">
                    <h5 class="modal-title">Crear Producto Rápido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formProductoRapido">
                        <div class="mb-3">
                            <label style="font-weight:bold; display:block; margin-bottom:5px;">Nombre del Producto</label>
                            <input type="text" id="new_nombre" class="form-control" required placeholder="Ej: Mouse Logitech" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="font-weight:bold; display:block; margin-bottom:5px;">Marca</label>
                                <input type="text" id="new_marca" class="form-control" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                            </div>
                            <div>
                                <label style="font-weight:bold; display:block; margin-bottom:5px;">Categoría</label>
                                <select id="new_categoria" class="form-control" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                                    <option th:each="cat : ${categorias}" th:value="${cat.idcategoria}" th:text="${cat.nombre}"></option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="font-weight:bold; display:block; margin-bottom:5px;">Precio Venta</label>
                                <input type="number" id="new_precio" class="form-control" step="0.01" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                            </div>
                            <div>
                                <label style="font-weight:bold; display:block; margin-bottom:5px;">Stock Mínimo</label>
                                <input type="number" id="new_stockMin" class="form-control" value="5" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label style="font-weight:bold; display:block; margin-bottom:5px;">Código Barras</label>
                            <input type="text" id="new_codigo" class="form-control" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" data-bs-dismiss="modal" style="color: #64748b; border: 1px solid #cbd5e1;">Cancelar</button>
                    <button type="button" class="btn btn-filled" style="background: #2563eb; color: white; border:none; padding:8px 15px; border-radius:4px;" onclick="guardarProductoAjax()">Guardar y Usar</button>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/js/script.js}"></script>
    <script>
        // --- VARIABLE GLOBAL PARA LOS PRODUCTOS ---
        let listaDetalles = [];

        // --- FUNCIÓN 1: GUARDAR PRODUCTO DESDE EL MODAL (AJAX) ---
        function guardarProductoAjax() {
            // ... (Tu código existente para guardar producto rápido) ...
            // Copia aquí el mismo código que te pasé en la respuesta anterior para esta función
            // O usa este bloque resumido:
            
            const data = {
                nombre: document.getElementById('new_nombre').value,
                marca: document.getElementById('new_marca').value,
                categoria: { idcategoria: document.getElementById('new_categoria').value },
                precio: parseFloat(document.getElementById('new_precio').value) || 0,
                stockMinimo: parseInt(document.getElementById('new_stockMin').value) || 5,
                codigoBarras: document.getElementById('new_codigo').value,
                stock: 0 
            };

            if (!data.nombre) { Swal.fire('Error', 'Nombre obligatorio', 'warning'); return; }

            fetch('/admin/inventario/api/guardar-rapido', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
            })
            .then(res => { if(!res.ok) throw new Error; return res.json(); })
            .then(producto => {
                const select = document.getElementById('selectProducto');
                select.add(new Option(producto.nombre + ' - ' + data.marca, producto.id, true, true));
                bootstrap.Modal.getInstance(document.getElementById('modalNuevoProducto')).hide();
                document.getElementById('formProductoRapido').reset();
                document.getElementById('inputCantidad').focus();
            })
            .catch(err => Swal.fire('Error', 'No se pudo crear', 'error'));
        }

        // --- FUNCIÓN 2: AGREGAR LÍNEA (MEMORIA Y VISTA) ---
        function agregarLineaCompra() {
            const select = document.getElementById('selectProducto');
            const idProd = select.value;
            const textoProd = select.options[select.selectedIndex].text;
            const cant = parseFloat(document.getElementById('inputCantidad').value);
            const costo = parseFloat(document.getElementById('inputCosto').value);

            if(!idProd || !cant || !costo) {
                Swal.fire('Faltan datos', 'Selecciona producto, cantidad y costo.', 'warning');
                return;
            }

            // 1. Agregar al Array Global
            const subtotal = cant * costo;
            listaDetalles.push({
                idProducto: idProd,
                nombre: textoProd,
                cantidad: cant,
                costo: costo,
                subtotal: subtotal
            });

            // 2. Renderizar Tabla
            renderizarTabla();

            // 3. Limpiar inputs
            document.getElementById('inputCantidad').value = "1";
            document.getElementById('inputCosto').value = "";
            select.value = "";
            select.focus();
        }

        function renderizarTabla() {
            const tbody = document.getElementById('tablaDetallesCompra');
            tbody.innerHTML = '';
            let totalGeneral = 0;

            if(listaDetalles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-3 text-muted">Agrega productos...</td></tr>';
                document.getElementById('montoTotal').value = "0.00";
                return;
            }

            listaDetalles.forEach((item, index) => {
                totalGeneral += item.subtotal;
                const fila = `
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 10px;">${item.nombre}</td>
                        <td style="padding: 10px; text-align: center;">${item.cantidad}</td>
                        <td style="padding: 10px; text-align: right;">S/ ${item.costo.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; font-weight: bold;">S/ ${item.subtotal.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: center;">
                            <button type="button" class="btn btn-sm text-danger" onclick="eliminarLinea(${index})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', fila);
            });

            // Actualizar input del Total (Visual)
            document.getElementById('montoTotal').value = totalGeneral.toFixed(2);
        }

        function eliminarLinea(index) {
            listaDetalles.splice(index, 1);
            renderizarTabla();
        }

        // --- FUNCIÓN 3: GUARDAR COMPRA EN BD ---
        // Asigna esta función al botón "Guardar Compra Completa" en el HTML
        function guardarCompraBD() {
            const idProv = document.getElementById('proveedor').value;
            const numComp = document.getElementById('numeroComprobante').value;
            const total = parseFloat(document.getElementById('montoTotal').value);

            if(!idProv || !numComp) {
                Swal.fire('Atención', 'Selecciona proveedor e ingresa número de comprobante.', 'warning');
                return;
            }
            if(listaDetalles.length === 0) {
                Swal.fire('Atención', 'La lista de productos está vacía.', 'warning');
                return;
            }

            const payload = {
                idProveedor: idProv,
                numeroComprobante: numComp,
                montoTotal: total,
                items: listaDetalles
            };

            Swal.fire({
                title: '¿Registrar Compra?',
                text: "Se actualizará el stock de los productos.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, registrar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/admin/compras/guardar-api', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })
                    .then(res => {
                        if(!res.ok) return res.text().then(t => { throw new Error(t) });
                        return res.json();
                    })
                    .then(data => {
                        Swal.fire('Éxito', 'Compra #' + data.id + ' registrada.', 'success')
                        .then(() => window.location.reload());
                    })
                    .catch(err => Swal.fire('Error', err.message, 'error'));
                }
            });
        }
    </script>
</body>
</html>